# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ RAG_ULTRA

## –û–±–∑–æ—Ä —É–ª—É—á—à–µ–Ω–∏–π

–ü—Ä–æ–µ–∫—Ç –±—ã–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞ —Å —É—á–µ—Ç–æ–º –∏–µ—Ä–∞—Ä—Ö–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- **LRU –∫—ç—à** –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ (—Ä–∞–∑–º–µ—Ä: 1000)
- **–ö—ç—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** —Ä–µ—Ä–∞–Ω–∫–µ—Ä–∞ (—Ä–∞–∑–º–µ—Ä: 5000)
- **–ö—ç—à –ø–æ–∏—Å–∫–æ–≤–∏–∫–∞** (—Ä–∞–∑–º–µ—Ä: 1000)
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–π** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### 2. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –±–∞—Ç—á–∏–Ω–≥
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞** –¥–ª—è CrossEncoder (4-16)
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** —Å ThreadPoolExecutor

### 3. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å
- **–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å** –¥–ª—è —Ä–µ—Ä–∞–Ω–∫–µ—Ä–∞ (max_workers: 2)
- **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–ª—è I/O
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**

### 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏
- **–£–º–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ** —Ç–µ–∫—Å—Ç–∞ –ø–æ —Ç–æ–∫–µ–Ω–∞–º
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤** (max_candidates_per_query: 100)
- **Early stopping** –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

## üéØ –£–ª—É—á—à–µ–Ω–∏—è —Ä–µ—Ä–∞–Ω–∫–µ—Ä–∞

### 1. –ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º
```python
RerankerConfig(
    kind="hybrid",  # CrossEncoder + Cosine
    hybrid_weights={"cross_encoder": 0.7, "cosine": 0.3}
)
```

### 2. –£—á–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **Heading weight**: 0.8 (–≤–∞–∂–Ω–æ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)
- **Path weight**: 0.6 (–≤–∞–∂–Ω–æ—Å—Ç—å –ø—É—Ç–∏)
- **Category weight**: 0.4 (–≤–∞–∂–Ω–æ—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
- **Structural coherence**: –∞–Ω–∞–ª–∏–∑ —Å–≤—è–∑–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü

### 3. –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã
- **Confidence threshold**: 0.3 (–ø–æ—Ä–æ–≥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏)
- **Early stopping**: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞
- **Smart truncation**: —É–º–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞

## üèóÔ∏è –£–ª—É—á—à–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç-–±–∏–ª–¥–µ—Ä–∞

### 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏
```python
ContextConfig(
    preserve_hierarchy=True,
    group_by_sections=True,
    min_section_coverage=0.7
)
```

### 2. –£–º–Ω–æ–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º** (1.2.3, 2.1, etc.)
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏**
- **–ê–Ω–∞–ª–∏–∑ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ–º–∞—Ç–∏–∫–∏**

### 3. –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞**: —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –ø–æ–∫—Ä—ã—Ç–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏
- **–£–º–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- **–ê–Ω–∞–ª–∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏** –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º

## üìä –ì—Ä–∞—Ñ–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä

### 1. –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **–ê–Ω–∞–ª–∏–∑ –Ω–æ–º–µ—Ä–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤** (1.2.3, –†–∞–∑–¥–µ–ª 1, etc.)
- **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–∞–∂–Ω–æ—Å—Ç–∏** —Ä–∞–∑–¥–µ–ª–æ–≤
- **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏** –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏

### 2. –ú–µ—Ç—Ä–∏–∫–∏ –≥—Ä–∞—Ñ–∞
- **–ì–ª—É–±–∏–Ω–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏**
- **–í–∞–∂–Ω–æ—Å—Ç—å —Ä–∞–∑–¥–µ–ª–æ–≤**
- **–°–≤—è–∑–Ω–æ—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã**

## ‚ö° –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### EmbeddingConfig
```python
@dataclass
class EmbeddingConfig:
    batch_size: int = 32
    max_concurrent_batches: int = 4
    enable_cache: bool = True
    cache_size: int = 10000
```

### RerankerConfig
```python
@dataclass
class RerankerConfig:
    batch_size: int = 8
    adaptive_batching: bool = True
    max_batch_size: int = 16
    min_batch_size: int = 4
    async_processing: bool = True
    max_workers: int = 2
```

## üîß –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

### 1. –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
```bash
python main_optimized.py
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```python
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞
rer_stats = rer.get_cache_stats()
use_stats = use.get_cache_stats()
base_stats = base.get_cache_stats()

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
rer.clear_cache()
use.clear_cache()
base.clear_cache()
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
```python
# –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
reranker_config = RerankerConfig(
    kind="hybrid",
    enable_cache=True,
    adaptive_batching=True,
    hierarchy_aware=True
)
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞**: 2-5x (–±–ª–∞–≥–æ–¥–∞—Ä—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é)
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–∞**: 3-8x (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –±–∞—Ç—á–∏–Ω–≥)
- **–°–Ω–∏–∂–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**: 20-40% (—É–º–Ω–æ–µ —É—Å–µ—á–µ–Ω–∏–µ)

### –ö–∞—á–µ—Å—Ç–≤–æ
- **–õ—É—á—à–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å**: —É—á–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏–∏
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç**: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º
- **–°–≤—è–∑–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**: –∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–π —Å–≤—è–∑–Ω–æ—Å—Ç–∏

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è **–æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã**
- –°—Ç–∞—Ä—ã–µ –∏–º–ø–æ—Ä—Ç—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã

### 2. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Python 3.8+
- sentence-transformers
- networkx
- numpy, faiss

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∫—ç—à–∞
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–π—Ç–µ –∫—ç—à
- –ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–∑–º–µ—Ä—ã –ø–æ–¥ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ

## üîç –û—Ç–ª–∞–¥–∫–∞ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### 1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# –í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
import logging
logging.basicConfig(level=logging.DEBUG)
```

### 2. –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
import cProfile
import pstats

profiler = cProfile.Profile()
profiler.enable()
# ... –≤–∞—à –∫–æ–¥ ...
profiler.disable()
stats = pstats.Stats(profiler)
stats.sort_stats('cumulative')
stats.print_stats()
```

### 3. –ê–Ω–∞–ª–∏–∑ –ø–∞–º—è—Ç–∏
```python
import tracemalloc
tracemalloc.start()
# ... –≤–∞—à –∫–æ–¥ ...
current, peak = tracemalloc.get_traced_memory()
print(f"–¢–µ–∫—É—â–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {current / 1024 / 1024:.1f} MB")
print(f"–ü–∏–∫–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: {peak / 1024 / 1024:.1f} MB")
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ë–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫
```python
from retrieval.searcher import SemanticSearcher
from retrieval.reranker import HierarchicalReranker

searcher = SemanticSearcher()
reranker = HierarchicalReranker(RerankerConfig())

# –ü–æ–∏—Å–∫ —Å —Ä–µ—Ä–∞–Ω–∫–∏–Ω–≥–æ–º
results = searcher.search("–≤–∞—à –∑–∞–ø—Ä–æ—Å")
reranked = reranker.rerank("–≤–∞—à –∑–∞–ø—Ä–æ—Å", results)
```

### –ö–æ–Ω—Ç–µ–∫—Å—Ç-–±–∏–ª–¥–µ—Ä
```python
from retrieval.context_builder import HierarchicalContextBuilder

builder = HierarchicalContextBuilder(ContextConfig())
context = builder.build(reranked)

print(f"–ö–∞—á–µ—Å—Ç–≤–æ: {builder.get_quality_metrics(context)}")
```

### –ì—Ä–∞—Ñ–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
```python
from graph_builder import HierarchicalGraphBuilder

graph_builder = HierarchicalGraphBuilder()
graph = graph_builder.build_graph(elements)
analysis = graph_builder.analyze_hierarchy()
```

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç:
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
- ‚úÖ **–£—á–µ—Ç –∏–µ—Ä–∞—Ä—Ö–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤**
- ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–µ—Ä–∞–Ω–∫–µ—Ä**
- ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç**
- ‚úÖ **–ì—Ä–∞—Ñ–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑**
- ‚úÖ **–ü–æ–ª–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**

–í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.
